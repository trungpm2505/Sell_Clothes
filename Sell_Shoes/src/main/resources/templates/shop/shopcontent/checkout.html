<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="shortcut icon" type="image/x-icon"
	href="shopview/assets/img/l.png">

<!-- all css here -->
<link rel="stylesheet" href="/shopview/assets/css/bootstrap.min.css">
<link rel="stylesheet" href="/shopview/assets/css/plugin.css">
<link rel="stylesheet" href="/shopview/assets/css/bundle.css">
<link rel="stylesheet" href="/shopview/assets/css/style.css">
<link rel="stylesheet" href="/shopview/assets/css/responsive.css">
<script src="/shopview/assets/js/vendor/modernizr-2.8.3.min.js"></script>


<!--
    - favicon
  -->
<link rel="shortcut icon"
	href="/shopview/assets/images/logo/favicon.ico" type="image/x-icon">

<!--
    - custom css link
  -->
<link rel="stylesheet" href="/shopview/assets/css/style-prefix.css">

</head>
<body>
	<div class="corner-popup" onclick="openCenterPopup()">Voucher
			giảm giá</div>


		<div id="centerPopup" class="center-popup">

			<div id="closeButton" onclick="closeCenterPopup()">X</div>

			<div class="voucher" id="Promotion">
				<div class="margin-title">
					<div class="title-vocher">
						<h4>Giảm giá 50%</h4>
					</div>
					<img class="img-vocher"
						src="https://cdn-icons-png.flaticon.com/128/3258/3258499.png"
						alt="Sản phẩm 1">
				</div>
				<div class="voucher-details">
					<button class="review-button" data-order-id="12345"
						id="discountCode" onclick="copyToClipboard()">Coppy mã</button>
					<div class="voucher-header">Mã giảmn giá 50K áp dụng cho toàn
						bộ đơn hàng</div>
					<ul>
						<li>Giảm tối đa: 50.000</li>
						<li>Ngày hết hạn: 30/11/2023</li>
						<li>Thể lệ: Cho toàn bộ đơn hàng</li>
					</ul>

					<div class="codevoucher" id="voucherCode">
						Your Voucher Code:
						<p class="codevoucher" id="predefinedText">JSPO2K3M</p>
					</div>
				</div>
			</div>

		</div>
	<div th:replace="shop/fragments/header::header"></div>
	<div class="container">
		<div class="breadcrumbs_area">
			<div class="row">
				<div class="col-12">
					<div class="breadcrumb_content">
						<ul>
							<li><a href="index.html">home</a></li>
							<li><i class="fa fa-angle-right"></i></li>
							<li>checkout</li>
						</ul>

					</div>
				</div>
			</div>
		</div>
		<!--breadcrumbs area end-->


		<!--Checkout page section-->
		<div class="Checkout_section">
			<div class="row">
				<div class="col-12"></div>
			</div>
			<div class="checkout_form">
				<div class="row">
					<div class="col-lg-6 col-md-6">
						<form action="#">
							<h3>Billing Details</h3>
							<div class="row">
								<div class="col-lg-4 mb-30">
									<label>Province/City<span>*</span></label> <select
										name="province" id="province">
										<option value="">Select province</option>
									</select> <small th:id="province-error"
										class="text-danger form-text error"></small>

								</div>
								<div class="col-lg-4 mb-30">
									<label>District<span>*</span></label> <select id="district"
										name="district">
										<option value="">Select district</option>
									</select> <small th:id="district-error"
										class="text-danger form-text error"></small>
								</div>
								<div class="col-lg-4 mb-30">
									<label>Wards <span>*</span></label> <select id="ward"
										name="ward">
										<option value="">Select ward</option>
									</select> <small th:id="ward-error" class="text-danger form-text error"></small>
								</div>
								<div class="col-12 mb-30">
									<label>Street address <span>*</span></label> <input
										id="address" name="address" placeholder="" type="text"
										th:value="${accountResponseDto.address}" /> <small
										style="font-size: 12px;" th:id="address-error"
										class="text-danger form-text error"></small>
								</div>
								<div class="col-lg-6 mb-30">
									<label>Full Name <span>*</span></label> <input type="text"
										id="fullName" name="fullName"
										th:value="${accountResponseDto.fullName}" /> <small
										style="font-size: 12px;" th:id="fullName-error"
										class="text-danger form-text error"></small>

								</div>
								<div class="col-lg-6 mb-30">
									<label> Phone <span>*</span></label> <input type="text"
										name="phone_Number" id="phone_Number"
										th:value="${accountResponseDto.phone}" /> <small
										style="font-size: 12px;" th:id="phone_Number-error"
										class="text-danger form-text error"></small>
								</div>
								<div class="col-lg-12 mb-30">
									<label> Email Address <span>*</span></label> <input type="text"
										th:value="${accountResponseDto.email}" readonly />
								</div>
								<!-- 	<div class="col-lg-4 mb-30">
									<label>Province/City<span>*</span></label> <select
										name="province" id="province">
										<option value="">Select province</option>
									</select>
				<small  th:id="province-error" class="text-danger form-text error"></small>
									
								</div>
								<div class="col-lg-4 mb-30">
									<label>District<span>*</span></label> <select id="district"
										name="district">
										<option value="">Select district</option>
									</select>
	      <small  th:id="district-error" class="text-danger form-text error"></small>								
								</div>
								<div class="col-lg-4 mb-30">
									<label>Wards <span>*</span></label> <select id="ward"
										name="ward">
										<option value="">Select ward</option>
									</select>
      	 <small  th:id="ward-error" class="text-danger form-text error"></small>																
								</div> -->


								<div class="col-12 mb-30">
									<label>Notes <span>*</span></label>
									<textarea placeholder="" rows="4" cols="4" id="note"
										name="note">
                                            </textarea>

								</div>


							</div>
						</form>
					</div>
					<div class="col-lg-6 col-md-6">
						<form action="#">
							<h3>Your order</h3>

							<div class="order_table table-responsive mb-30">
								<table id="checkoutTable">
									<thead>
										<tr>
											<th>Image</th>
											<th>Shoe name</th>
											<th>Shoe color</th>
											<th>Shoe size</th>
											<th>Quantity</th>
											<th>Price</th>
										</tr>
									</thead>
									<tbody id="checkoutBody">

										<tr th:each="cartItem : ${cartResponseDtos}">

											<td><input type="hidden" id="cartId" class="cartId"
												th:value="${cartItem.cartId}"> <img
												th:src="@{/upload/__${cartItem.images.inmageForSave}__}"
												alt="" width="80" height="60" /></td>
											<td th:text="${cartItem.productResponseDto.title}"></td>
											<td th:text="${cartItem.variantResponseDto.color}"></td>
											<td th:text="${cartItem.variantResponseDto.size}"></td>
											<td th:text="${cartItem.quantity}"></td>
											<td th:text="${cartItem.total}"></td>

										</tr>

									</tbody>
									<tfoot>
										<tr>
											<td colspan="7">
												<div class="coupon">
													<label for="coupon_code">Do you have a discount
														code? Please enter here</label>
													<div class="coupon-input">
														<input type="text" id="coupon_code" name="coupon_code"
															placeholder="Enter your coupon code" />
														<button type="button" id="applyCouponBtn"
															class="apply_coupon">Apply discount code</button>


													</div>
													<small style="font-size: 14px;" th:id="couponCode-error"
														class="text-danger form-text error"></small>
												</div>

											</td>
										</tr>
										<tr>
											<th>Discount code</th>
											<td></td>
											<td></td>
											<td></td>
											<td></td>
											<td><strong id="discountTypeDisplay">0đ</strong></td>
										</tr>
										<tr>
											<th>Tổng tiền</th>
											<td></td>
											<td></td>
											<td></td>
											<td></td>
											<td><strong id="total" th:text="${total}"
												style="font-weight: bold;"></strong></td>

											<input type="hidden" th:value="${total}"
												id="originalTotalValue" name="originalTotalValue">

										</tr>



									</tfoot>
								</table>
							</div>



							<div class="payment_method">
								<!-- Thêm mã giảm giá ở đây -->
								<div class="panel-default">
									<div id="method" class="collapse one" data-parent="#accordion">
										<div class="card-body1">
											<p>Please send a check to Store Name, Store Street, Store
												Town, Store State / County, Store Postcode.</p>
										</div>
									</div>
								</div>


								<div class="panel-default" onclick="$('#payment_info').hide()">

									<input id="payment_bank_transfer" name="check_method"
										type="radio" checked data-target="createp_account"> <label
										class="custom-control-label" for="credit">Payment on
										delivery</label>

								</div>
								<div class="panel-default" onclick="$('#payment_info').show()">
									<input id="payment_bank_transfer" name="check_method"
										type="radio" data-target="createp_account"> <label
										class="custom-control-label" for="debit">Payment by
										bank transfer</label>
								</div>
								<div class="row" id="payment_info" style="display: none;">
									<div class="col-md-6 mb-3">
										<label for="cc-name">
											<h5>STK : 1903 7531 0590 11</h5>
											<div>Ngân Hàng : Techcombank</div>
											<div>Chi Nhánh : Quảng Nam</div>
											<div>Chủ TK : PHAM MINH TRUNG</div>
											<h5>
												<br> HOTLINE:&nbsp; 0335.247.942
											</h5>
										</label>
									</div>
								</div>
								<div class="order_button">
									<button id="checkoutButton" type="button">Proceed To
										Order</button>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div th:replace="shop/fragments/footer::footer"></div>
	<script src="/shopview/assets/js/vendor/jquery-1.12.0.min.js"></script>
	<script src="/shopview/assets/js/popper.js"></script>
	<script src="/shopview/assets/js/bootstrap.min.js"></script>
	<script src="/shopview/assets/js/ajax-mail.js"></script>
	<script src="/shopview/assets/js/plugins.js"></script>

	<script type="module"
		src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
	<script nomodule
		src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
		integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.26.1/axios.min.js"
		integrity="sha512-bPh3uwgU5qEMipS/VOmRqynnMXGGSRv+72H/N260MQeXZIK4PG48401Bsby9Nq5P5fz7hy5UGNmC/W1Z51h2GQ=="
		crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script>
	var inputList = [ 'fullName','phone_Number','address','province'];

	inputList.forEach(function(inputName) {
		var input = document.getElementById(inputName);
		var error = document.getElementById(inputName + '-error');

		if (input) { // Kiểm tra xem phần tử input có tồn tại không
			input.addEventListener("focus", function() {
				error.textContent = '';
			});
		} else {
			console.error("Element with id '" + inputName
					+ "' not found in the page.");
		}
	});
	 
        var confirmedPrice = 0;
		var promotionId=0;
	 	var selectedProvince = null;
		var selectedDistrict = null;
		var selectedward = null; 

		function formatCurrency(value) {
		    return value.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
		}

		// Áp dụng định dạng tiền tệ cho các giá trị giày
		document.querySelectorAll("#checkoutBody td:nth-child(6)").forEach(function(element) {
		    var value = parseFloat(element.textContent);
		    if (!isNaN(value)) {
		        element.textContent = formatCurrency(value);
		    }
		});
		var originalTotalValue = document.getElementById("originalTotalValue").value;
		var totalElement = document.getElementById("total");

		if (totalElement && !isNaN(originalTotalValue)) {
		    var formattedTotal = formatCurrency(parseFloat(originalTotalValue));
		    totalElement.innerHTML = `<strong>${formattedTotal}</strong>`;

		}
	
	     // Sử dụng jQuery để lắng nghe sự kiện khi giá trị của select thay đổi
	         $('#province').on('change', function() {
	        	selectedProvince =   $(this).find("option:selected").text(); // Lấy văn bản của lựa chọn đã chọn
	            console.log('Tên tỉnh được chọn:', selectedProvince);
	           
	        });
	        $('#district').on('change', function() {
	        	selectedDistrict = $(this).find("option:selected").text();
	            console.log('Tên quận huyện được chọn:', selectedDistrict);
	           
	        });
	        $('#ward').on('change', function() {
	        	selectedward = $(this).find("option:selected").text(); 
	            console.log('Tên phường xã được chọn:', selectedward);
	          
	        }); 

	        
		$('#checkoutButton').on('click', function() {

						
		    var formData = {
		        fullName: $('#fullName').val(),
		        phone_Number: $('#phone_Number').val(),
		        address:  $('#address').val(),
		        province : selectedProvince ,
		        district : selectedDistrict ,
		        ward : selectedward , 
		        note: $('#note').val(),
		        confirmedPrice: confirmedPrice,
		        promotionId : promotionId, 
		        cartIds: [] // Khởi tạo mảng cartIds
		    };

		    // Lặp qua các phần tử có class 'cartId' và thêm giá trị vào mảng 'cartIds'
		    $('.cartId').each(function() {
		        formData.cartIds.push($(this).val());
		    });
		    if (!selectedProvince || selectedProvince === 'chọn tỉnh') {
		        // Nếu không có tỉnh/thành phố được chọn, hiển thị thông báo lỗi
		        $("#province-error").text("Please select province/city!");
		        return; // Dừng việc tiếp tục thực hiện thanh toán
		    } else {
		        // Nếu tỉnh/thành phố đã được chọn, xóa thông báo lỗi (nếu có)
		        $("#province-error").text("");
		    }
		  if (!selectedDistrict || selectedDistrict === 'chọn quận huyện') {		
		        $("#district-error").text("Please district!");
		        return; 
		    } else {
		        $("#district-error").text("");
		    }
		  if (!selectedward || selectedward === 'chọn phường xã') {		      
		        $("#ward-error").text("Please commune!");
		        return; 
		    } else {		       
		        $("#ward-error").text("");
		    }
		    // Gửi dữ liệu đặt hàng lên server
		    $.ajax({
		        type: 'POST',
		        url: '/userOrder/addOrder',
		        contentType: 'application/json',
		        data: JSON.stringify(formData),
		        success: function(response) {
		            console.log('Đặt hàng thành công!', response);		           
		            var totalElement = document.getElementById("total");
		            window.location.href = "/userOrder/order-success";
		        },
		    	error: function(jqXHR, textStatus, errorThrown){
				 	if (jqXHR.status === 400) {
		      	       var errors = jqXHR.responseJSON;
		      	        if (errors.hasOwnProperty("bindingErrors")) {
		      	            var bindingErrors = errors["bindingErrors"];
		      	            for (var i = 0; i < bindingErrors.length; i++) {
		      	                var error = bindingErrors[i];
							    // Hiển thị thông báo lỗi trong tag ID đã tạo
							    $("#" + error.field + "-error").text(error.defaultMessage);
		      	            }
		      	        }
		      	    }else{
						   alert("Sorry! The system have errors!") 
					}
				 	 	
				}
		    });
		});


		document.getElementById("applyCouponBtn").addEventListener("click", function() {
		    var couponCode = document.getElementById("coupon_code").value;
		    var originalTotalValue = document.getElementById("originalTotalValue").value; // lấy giá gốc

		    $.ajax({
		        type: 'GET',
		        url: '/userOrder/applyPromotionByCode',
		        data: { coupon_code: couponCode }, // Truyền mã giảm giá qua tham số truy vấn
		        success: function(response) {
		            console.log('Áp dụng mã giảm giá thành công!', response);
		            $("#couponCode-error").text("");
		            promotionId = response.id;

		            // Hiển thị giá trị giảm giá và cập nhật confirmedPrice
		            if (response.discountType == 2) {
		            	console.log("goc")
		                document.getElementById("discountTypeDisplay").innerHTML = response.discountValue.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
		            
		                var discountedPrice = originalTotalValue - response.discountValue;
		                updateConfirmedPrice(discountedPrice);
		                updateTotalElement(discountedPrice);
		            } else if (response.discountType === 1) {
		            	console.log("%")

		                var totalRate = parseFloat(originalTotalValue);
		                var discountValue = parseFloat(response.discountValue);

		                if (!isNaN(totalRate) && !isNaN(discountValue)) {
		                    var rate = 0;
		                    var discount = totalRate * discountValue / 100;
			            	console.log(response)

		                    if (discount > response.maxValue) {
		                        rate = totalRate - response.maxValue;
		                        document.getElementById("discountTypeDisplay").innerHTML = response.maxValue.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });;
		                    } else {
		                        rate = totalRate - discount;
		                        document.getElementById("discountTypeDisplay").innerHTML = discount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
		                    }

		                    updateConfirmedPrice(rate);
		                    updateTotalElement(rate);
		                } else {
		                    console.error("Invalid input. Please check the values.");
		                }
		            }
		        },
		        error: function(jqXHR, textStatus, errorThrown) {
		            if (jqXHR.status === 400) {
		                var errors = jqXHR.responseJSON;
		                if (errors.hasOwnProperty("couponCode")) {
		                    $("#couponCode-error").text(errors["couponCode"]);
		                }
		            } else if (jqXHR.status === 404) {
		                $("#couponCode-error").text("Invalid discount code! Please re-enter.");
		            } else {
		                $("#couponCode-error").text("Xảy ra lỗi. Vui lòng thử lại sau.");
		            }
		        }
		    });
		});

		// Hàm cập nhật confirmedPrice
		function updateConfirmedPrice(price) {
		    confirmedPrice = price;
		}

		// Hàm cập nhật giá trị total
		function updateTotalElement(value) {
			 var formattedValue = formatCurrency(value);
		    document.getElementById("total").innerHTML = formattedValue;		    
		}
		

	//api gọi tỉnh thành
		const host = "https://provinces.open-api.vn/api/";
        var callAPI = (api) => {
            return axios.get(api).then((response) => {
                renderData(response.data, "province");
            });
        };
        callAPI("https://provinces.open-api.vn/api/?depth=1");

        var callApiDistrict = (api) => {
            return axios.get(api).then((response) => {
                renderData(response.data.districts, "district");
            });
        };
        var callApiWard = (api) => {
            return axios.get(api).then((response) => {
                renderData(response.data.wards, "ward");
            });
        };

        var renderData = (array, select) => {
            let row = ' <option disable value="">chọn</option>';
            array.forEach((element) => {
                row += `<option value="${element.code}">${element.name}</option>`;
            });
            document.querySelector("#" + select).innerHTML = row;
        };

        $("#province").change(() => {
            callApiDistrict(host + "p/" + $("#province").val() + "?depth=2");            
        });
        $("#district").change(() => {
            callApiWard(host + "d/" + $("#district").val() + "?depth=2");         
        });


        function openCenterPopup() {
            document.getElementById('centerPopup').style.display = 'block';
            document.removeEventListener('click', outsideClickHandler);
        }

        function closeCenterPopup() {
            document.getElementById('centerPopup').style.display = 'none';
            document.addEventListener('click', outsideClickHandler);
        }
        function copyToClipboard() {
            const predefinedText = document.getElementById('predefinedText').innerText;
            const textarea = document.createElement('textarea');
            textarea.value = predefinedText;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Đã sao chép vocher');
        }

      ///// promotion
      loadPromotion()
      function loadPromotion() {
          $.ajax({
              url: '/promotion/getProductPage',
              type: 'GET',
              success: function (response) {
                  var centerPopup = $("#centerPopup");

                  //Xóa nội dung hiện có
                  centerPopup.empty();

                  if (response.promotionResponseDtos && response.promotionResponseDtos.length > 0) {
                      // Lặp lại dữ liệu khuyến mãi và thêm vào centerPopup
                      $.each(response.promotionResponseDtos, function (index, promotion) {
                      // Kiểm tra xem chương trình khuyến mãi có đang hoạt động không
                      if (promotion.active) {
                      	var imagesHtml = `<img src="https://cdn-icons-png.flaticon.com/512/3258/3258499.png" alt="Promotion Image">`;
							// Giả sử bạn có hình ảnh cho mỗi chương trình khuyến mãi
							
                          // Lặp qua các hình ảnh quảng cáo
                          $.each(promotion.images, function (imgIndex, image) {
                              imagesHtml += `<img src="${image.url}" alt="Promotion Image">`;
                          });

                          // Xây dựng promotion HTML
                                                          
                          var promotionHtml = `
                          	<div id="closeButton" onclick="closeCenterPopup()">X</div>
                              <div class="voucher" id="Promotion${promotion.id}">
                                  <div class="margin-title">
                                      <div class="title-vocher">
                                          <h4>Voucher ${promotion.name}</h4>
                                      </div>
                                      ${imagesHtml}
                                  </div>
                                  <div class="voucher-details">
                                  <button class="review-button" data-promotion-id="${promotion.id}" onclick="applyPromotion('${promotion.couponCode}')">Coppy code</button>
                                      <div class="voucher-header">Discount code ${promotion.name} applies to entire order </div>
                                      <ul>                                                
                                          <li>Discount Value: ${promotion.discountType === 1 ? `${promotion.discountValue}%` : `${promotion.discountValue.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' })}`}</li>
                                          <li>Max Value: ${promotion.maxValue.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' })}</li>                                                    
                                          <li>Expired Date: ${promotion.expiredDate}</li>
                                          <li >Coupon Code: ${promotion.couponCode}</li> <!-- Add this line for Coupon Code -->
                                      </ul>
                                  </div>
                              </div>
                          `;

                          // Nối HTML voucher vào centerPopup
                          centerPopup.append(promotionHtml);
                      }
                  });
                  } else {
                      // Nếu không có voucher, hiển thị ảnh full
                      centerPopup.html('<div id="closeButton" onclick="closeCenterPopup()">X</div><img src="https://images.fpt.shop/unsafe/filters:quality(90)/fptshop.com.vn/uploads/images/2015/Tin-Tuc/ThuVTK/giam8phantram_1.png" alt="Chưa có voucher nào"><div><p style="font-size:20px; text-align: center;font-weight: bold;">Cùng chờ đón mùa sale lớn giáng sinh</p</div>');
						
                  }

                  //Lặp lại dữ liệu khuyến mãi và thêm vào centerPopup
                  
              },
              error: function (jqXHR, textStatus, errorThrown) {
                  console.error('Error loading promotion data:', errorThrown);
              }
          });
      }

                              
     //Thêm chức năng này để xử lý việc sao chép mã giảm giá
     function applyPromotion(couponCode) {
         //Sử dụng tham số couponCode được cung cấp để sao chép vào bảng nhớ tạm
         const textarea = document.createElement('textarea');
         textarea.value = couponCode;
         document.body.appendChild(textarea);
         textarea.select();
         document.execCommand('copy');
         document.body.removeChild(textarea);

         //Hiển thị thông báo hoặc thực hiện các hành động bổ sung
         alert(`Coupon Code "${couponCode}" has been copied to the clipboard.`);
   	}
    
    </script>



</body>
</html>